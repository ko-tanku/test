このドキュメントは、現在のDocusaurusプロジェクトの自動生成部分の構造と、Docusaurusのベストプラクティスに基づいた理想的な構造を比較し、その差異と今後の提案をまとめたものです。

## 1. 現在のプロジェクト構造

現在のプロジェクトは、以下の特徴を持つ自動生成プロセスを採用しています。

*   **コンテンツソース:** `scripts/courses/[コース名]/source/pages/[ページID]/` ディレクトリ内に、`meta.yaml` (メタデータ), `prose.md` (Markdownコンテンツ), `components.yaml` (コンポーネント定義) が個別に配置されています。
*   **生成スクリプト:** Pythonスクリプト (`build.py`) がこれらのファイルを読み込み、結合して単一のJSONファイル (`static/data/[コース名]/pages.json`) を生成します。
*   **Docusaurusプラグイン:** カスタムDocusaurusプラグイン (`plugins/[コース名]-plugin/index.js`) が、Pythonが生成したJSONファイルを読み込み、`actions.addRoute()` を使用して動的にページを生成します。
*   **ページコンポーネント:** `src/components/ComprehensiveTestPage.js` が、プラグインから渡されたJSONデータに基づいてページの内容をレンダリングします。

**利点:**
*   コンテンツが細かく構造化されており、再利用性が高い。
*   コンテンツ作成者がMarkdown、YAMLというシンプルな形式でコンテンツを記述できる。
*   Pythonスクリプトによる柔軟なデータ処理が可能。

**課題:**
*   **Pythonスクリプトの複雑性:** `build.py` が複数のファイルを読み込み、それらを結合してJSONを生成するロジックが複雑になりがちです。特に、`prose.md` の内容をJSONに埋め込む際のエスケープ処理や、`components.yaml` の構造をそのままJSONに変換する際の整合性維持が課題となります。
*   **エラー発生の可能性:** PythonスクリプトとJavaScript（Docusaurusプラグイン、Reactコンポーネント）間のデータ連携において、スキーマの不一致やエスケープの不備などによりエラーが発生しやすい。
*   **デバッグの複雑性:** 問題発生時、Pythonスクリプト、生成されたJSON、Docusaurusプラグイン、Reactコンポーネントのどこに問題があるかを特定するのが難しい。

## 2. Docusaurusのベストプラクティスに基づいた理想的な構造

Docusaurusの設計思想とベストプラクティスを最大限に活用すると、以下のような構造が理想的と考えられます。

### 2.1. データ駆動型ページ生成（現在のプロジェクトが目指す方向）

このアプローチは、現在のプロジェクトが目指している「PythonでJSONを生成し、Docusaurusプラグインで処理」する方向性と一致します。

*   **コンテンツソース:** Pythonスクリプトが生成する**純粋なJSONファイル** (`static/data/[コース名]/pages.json`) がコンテンツの主要なソースとなります。
*   **Pythonスクリプトの役割:** `build.py` は、`meta.yaml`, `prose.md`, `components.yaml` を読み込み、それらを結合して**定義されたJSONスキーマに厳密に従ったJSONデータ**を生成することに特化します。JSXの生成には一切関与しません。
*   **Docusaurusプラグイン:** カスタムDocusaurusプラグインが、Pythonが生成したJSONファイルを読み込み、`actions.addRoute()` を使用して動的にページを生成します。このプラグインは、JSONデータをページコンポーネントに渡す役割を担います。
*   **ページコンポーネント:** `src/components/[コース名]/ComprehensiveTestPage.js` のようなReactコンポーネントが、プラグインから渡されたJSONデータを受け取り、そのデータに基づいてページの内容をレンダリングします。**Markdownコンテンツのレンダリングには`@theme/MDXContent`を、カスタムコンポーネントのレンダリングには`React.lazy`と`Suspense`を用いた動的インポートと、`componentMap`によるマッピングを使用します。**

**利点:**
*   Pythonスクリプトはデータ変換に集中でき、JSX生成の複雑性から解放されるため、安定性が向上します。
*   Docusaurus側でページの動的な生成とレンダリングを行うため、システムの安定性と拡張性が高まります。
*   コンテンツと表示ロジックの分離が明確になります。

**課題:**
*   初期設定として、カスタムDocusaurusプラグインとReactコンポーネントの開発が必要。
*   JSONデータのスキーマ定義と、Pythonスクリプトによるそのスキーマへの厳密な準拠が重要。

### 2.2. MDX直接記述（シンプルなケース）

よりシンプルなケースでは、Pythonスクリプトによる前処理を最小限に抑え、DocusaurusのネイティブなMDX機能を最大限に活用します。

*   **コンテンツソース:** `docs/[コース名]/[ページID].mdx` ファイルが直接コンテンツのソースとなります。
*   **MDXファイルの内容:** MDXファイル内に、Markdownコンテンツ、YAMLフロントマター、そしてカスタムReactコンポーネントの呼び出しを直接記述します。
*   **Pythonスクリプトの役割:** 既存のYAML/MarkdownファイルをMDXに一度だけ変換するスクリプトとして使用するか、あるいは完全に廃止します。

**利点:**
*   最もシンプルで、Docusaurusのネイティブな機能に最も近い。
*   ビルドプロセスが非常に安定している。

**課題:**
*   コンテンツがMDXファイル内に集約されるため、コンテンツの再利用性や細粒度での管理が難しくなる場合がある。
*   コンテンツ作成者がMDX（JSX）の知識をある程度必要とする。

## 3. 現状のシステムと理想的な構造の差異

現在のプロジェクトは、上記「2.1. データ駆動型ページ生成」の方向性を目指していますが、その実装においていくつかの差異と課題を抱えています。

*   **Pythonスクリプトの役割の曖昧さ:**
    *   現状の`build.py`は、JSON生成に加えて、過去のMDX生成ロジックの一部が残っていたり、デバッグ用の`print`文が混在していたりするなど、役割が明確に分離されていませんでした。
    *   **差異:** 理想的な構造では、Pythonスクリプトは純粋なJSONデータ生成に特化すべきです。
*   **JSONデータスキーマの厳密性:**
    *   `build.py`が生成するJSONデータのスキーマが、DocusaurusプラグインやReactコンポーネントが期待する形式と完全に一致していないことが、これまでのエラーの原因となっていました。
    *   **差異:** 理想的な構造では、JSONスキーマを明確に定義し、Pythonスクリプトがそのスキーマに厳密に準拠してデータを生成する必要があります。
*   **コンポーネントのプロパティ渡し:**
    *   `ComprehensiveTestPage.js`内で、`pageData.components`から取得したコンポーネントのプロパティを、各コンポーネントが期待する形式に手動でマッピングする必要がありました（例: `Tabs`の`items`を`tabs`に、`MultipleChoice`の`props`を`quizData`に）。
    *   **差異:** 理想的には、Pythonスクリプトが生成するJSONデータ内のコンポーネントの`props`が、Reactコンポーネントが直接受け取れる形式であるべきです。これにより、`ComprehensiveTestPage.js`内のマッピングロジックを簡素化できます。
*   **MDXコンテンツのレンダリング:**
    *   `prose_content`を`@theme/MDXContent`でレンダリングするアプローチは正しいですが、`prose_content`内の数式表示など、MDXの特定の機能が正しく動作しない問題がありました。
    *   **差異:** `prose_content`内のMarkdownが、DocusaurusのMDXパーサーによって完全にサポートされる形式であることを確認する必要があります。

## 4. 今後の提案

現在のプロジェクトは、Docusaurusのベストプラクティスに沿った「データ駆動型ページ生成」の方向性を目指す上で、非常に良い基盤を持っています。しかし、PythonスクリプトとJavaScript間のデータ連携の正確性を高めることが、安定性と効率性を向上させる鍵となります。

**具体的な提案:**

1.  **Pythonスクリプト (`build.py`) の役割の厳密な分離:**
    *   `build.py`は、`meta.yaml`, `prose.md`, `components.yaml`を読み込み、**純粋なJSONデータ**を生成することに徹します。
    *   `prose_content`内のMarkdownや`components`内のプロパティは、JavaScript側で解釈されることを前提とした形式でJSONに埋め込みます。
2.  **JSONスキーマの最終確定と厳密な実装:**
    *   DocusaurusプラグインとReactコンポーネントが期待するJSONスキーマを明確に定義し、`build.py`がそのスキーマに厳密に準拠してデータを生成するようにします。
3.  **`ComprehensiveTestPage.js` の簡素化:**
    *   Pythonスクリプトが生成するJSONデータ内のコンポーネントの`props`が、各Reactコンポーネントが直接受け取れる形式になるように調整することで、`ComprehensiveTestPage.js`内の条件分岐やマッピングロジックを最小限に抑えます。
4.  **`prose_content`のMarkdown/MDX互換性の確認:**
    *   `prose_content`内のMarkdownが、DocusaurusのMDXパーサーによって完全にサポートされる形式であることを確認し、必要に応じて修正します。
